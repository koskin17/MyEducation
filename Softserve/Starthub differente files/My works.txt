## 1Ô∏è‚É£ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–¢–≤–æ–π `UserViewSet.register` –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö –≤ `UserRegistrationSerializer`.
2. `UserRegistrationSerializer`:

   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å email –∏ username.
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∏ confirm\_password.
   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ `validate_password`.
   * –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`UserProfile.objects.create_user`) —Å **–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º –∞–∫–∫–∞—É–Ω—Ç–æ–º** (`is_active = False`).
   * –°–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`StartupProfile` –∏–ª–∏ `InvestorProfile`).
3. –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞—ë—Ç—Å—è **—Ç–æ–∫–µ–Ω –∞–∫—Ç–∏–≤–∞—Ü–∏–∏** (`generate_activation_token(user)`), –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ email.

‚úÖ **–í—ã–≤–æ–¥:** —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞–Ω–∏—é.

---

## 2Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

–í `register`:

```python
token = generate_activation_token(user)
activation_url = f"{settings.FRONTEND_URL}/activate?token={token}"
send_mail(
    subject='Confirm your email',
    html_message=f'Click on the link to activate your account: <a href="{activation_url}"></a>',
    from_email=settings.DEFAULT_FROM_EMAIL,
    recipient_list=[user.email]
)
```

* –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Å—Å—ã–ª–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
* –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `UserViewSet.activate`, –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `verify_activation_token(token)`.

‚úÖ **–í—ã–≤–æ–¥:** –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ email —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.

---

## 3Ô∏è‚É£ –õ–æ–≥–∏–Ω –∏ —Ç–æ–∫–µ–Ω—ã

`login`:

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç email –∏ –ø–∞—Ä–æ–ª—å (`authenticate`).
2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:

   * –°–æ–∑–¥–∞—ë—Ç `RefreshToken` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å `refresh` –∏ `access`.
   * –í JSON —Ç–∞–∫–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (`id`, `email`, `username`, `role`).

‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

* `authenticate` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `is_active`. –¢–æ –µ—Å—Ç—å **–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–º–æ–∂–µ—Ç –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è**, —á—Ç–æ –ª–æ–≥–∏—á–Ω–æ.
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **JWT —Ç–æ–∫–µ–Ω—ã** –æ—Ç `rest_framework_simplejwt`.

‚úÖ **–í—ã–≤–æ–¥:** –ª–æ–≥–∏–Ω –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã.

---

## 4Ô∏è‚É£ Logout –∏ blacklist

`LogoutView.post`:

```python
refresh_token = request.data["refresh"]
token = RefreshToken(refresh_token)
token.blacklist()
```

* –°–∏—Å—Ç–µ–º–∞ –±–µ—Ä—ë—Ç `refresh` —Ç–æ–∫–µ–Ω –∏ –∑–∞–Ω–æ—Å–∏—Ç –µ–≥–æ –≤ `blacklist`.
* –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `access` —Ç–æ–∫–µ–Ω–∞.

‚úÖ **–í—ã–≤–æ–¥:** logout —Å –∑–∞–Ω–µ—Å–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –≤ blacklist —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.

---

## 5Ô∏è‚É£ –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è

* `reset_password_request` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–æ —Å —Ç–æ–∫–µ–Ω–æ–º —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.
* `validate_reset_token` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞.
* `reset_password` ‚Äî –º–µ–Ω—è–µ—Ç –ø–∞—Ä–æ–ª—å, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω –∏ –ø–∞—Ä–æ–ª—å –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é.

‚úÖ **–í—ã–≤–æ–¥:** —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.

---

## üîπ –û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ —Ä–∞–±–æ—Ç—ã

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –ø–∏—Å—å–º–æ —Å —Ç–æ–∫–µ–Ω–æ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∞–∫–∫–∞—É–Ω—Ç ‚Üí `is_active = True`.
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí –ø–æ–ª—É—á–∞–µ—Ç `access` –∏ `refresh` —Ç–æ–∫–µ–Ω—ã.
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç logout ‚Üí `refresh` —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ blacklist.
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –ø–∏—Å—å–º–æ ‚Üí –º–µ–Ω—è–µ—Ç –ø–∞—Ä–æ–ª—å.

---

## üîπ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚úÖ
* –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É ‚úÖ
* –õ–æ–≥–∏–Ω + JWT —Ç–æ–∫–µ–Ω—ã ‚úÖ
* Logout + –∑–∞–Ω–µ—Å–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ blacklist ‚úÖ
* –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ email ‚úÖ

---

## Verdict

–¢—ã –≤—ã–ø–æ–ª–Ω–∏–ª –∑–∞–¥–∞—á—É –ø–æ —Å–º—ã—Å–ª—É: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ WebSocket —Ç–µ–ø–µ—Ä—å –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ JWT, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π –≤ URL (?token=...), middleware –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω, –∫–ª–∞–¥—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ scope, –∞ consumer –ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö. –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ‚ÄúUpdate the authorization process via websockets‚Äù –∏ ‚ÄúProvide JWT via url‚Äù.

–ù–∏–∂–µ ‚Äî –ø–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É (–ø–∞—Ä–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –Ω—é–∞–Ω—Å–æ–≤), –∏ –∫–∞–∫ —É—Å–∏–ª–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ.

---

## –ü–æ—á–µ–º—É —Ä–µ—à–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

- **JWT —á–µ—Ä–µ–∑ URL:** –í JWTAuthMiddleware —Ç—ã –ø–∞—Ä—Å–∏—à—å query_string, –±–µ—Ä—ë—à—å token –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—à—å —á–µ—Ä–µ–∑ Simple JWT (AccessToken). –ü—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ–º —Ç–æ–∫–µ–Ω–µ –ø–æ–ª—É—á–∞–µ—à—å user –∏ –ø–æ–º–µ—â–∞–µ—à—å –≤ scope["user"].  
- **–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö:** –í ChatConsumer.connect —Ç—ã –ø—Ä–æ–≤–µ—Ä—è–µ—à—å scope["user"].is_authenticated; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –æ—à–∏–±–∫—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—à—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.  
- **ASGI-—Ü–µ–ø–æ—á–∫–∞:** WebSocket-—Ç—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ç–≤–æ–π middleware –∏ URLRouter ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–æ–≤.

–ò—Ç–æ–≥–æ: —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.

---

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å

- **–ü–æ—Ä—è–¥–æ–∫ middleware –≤ ASGI:** –°–µ–π—á–∞—Å —É —Ç–µ–±—è JWTAuthMiddleware —Å–Ω–∞—Ä—É–∂–∏ –æ—Ç AuthMiddlewareStack. –í —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ AuthMiddlewareStack –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å scope["user"] –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ JWT (–≤–µ—Ä–Ω—ë—Ç AnonymousUser –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–µ—Å—Å–∏–∏). –ß—Ç–æ–±—ã JWT –±—ã–ª ‚Äú–ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º‚Äù, –ø–æ–º–µ—Å—Ç–∏ JWTAuthMiddleware –í–ù–£–¢–†–¨ AuthMiddlewareStack.  
  –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ö–µ–º–∞:

  ```python
  # backend/config/asgi.py
  from channels.routing import ProtocolTypeRouter, URLRouter
  from channels.auth import AuthMiddlewareStack
  from channels.security.websocket import AllowedHostsOriginValidator
  from users.middleware import JWTAuthMiddleware
  from communications.routing import websocket_urlpatterns
  from django.core.asgi import get_asgi_application
  import os

  os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

  application = ProtocolTypeRouter({
      "http": get_asgi_application(),
      "websocket": AllowedHostsOriginValidator(
          AuthMiddlewareStack(
              JWTAuthMiddleware(
                  URLRouter(websocket_urlpatterns)
              )
          )
      ),
  })
  ```

## –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —á–µ–∫‚Äë–ª–∏—Å—Ç –¥–ª—è –ø—Ä–∏—ë–º–∫–∏

- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞:** ws://.../ws/chat/room/?token= ‚Äî —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç {"error":"Authentication required"} –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
- **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω:** –¢–æ—á–Ω–æ —Ç–∞–∫ –∂–µ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è.
- **–í–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω:** –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –≥—Ä—É–ø–ø—É, –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–µ—Å—Å–∏–∏:** –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫—É–∫–∏‚Äë—Å–µ—Å—Å–∏–∏ JWT –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±–ª–∞–≥–æ–¥–∞—Ä—è –ø–æ—Ä—è–¥–∫—É middleware).
- **–õ–æ–≥–∏:** –¢–æ–∫–µ–Ω—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ª–æ–≥–∏/—Ç—Ä–µ–∫–µ—Ä—ã.

–û—Ç–ª–∏—á–Ω–æ, —É —Ç–µ–±—è —É–∂–µ —Å–æ–±—Ä–∞–Ω –≤–µ—Å—å —Å—Ç–µ–∫ –¥–ª—è **–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ WebSocket —Å JWT** üî•
–î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É, –∫–∞—Å–∞—é—â—É—é—Å—è **authorization / update the authorization process via websockets**, –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:

---

## üîπ `middleware.py`

```python
User = get_user_model()
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ü–æ–ª—É—á–∞–µ—Ç –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑–∞–Ω–∞ –≤ `settings.AUTH_USER_MODEL`.
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** –≠—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –Ω–∞–ø–∏—Å–∞—Ç—å `from users.models import UserProfile`, –Ω–æ —ç—Ç–æ –ø—Ä–∏–≤—è–∑–∞–ª–æ –±—ã –∫–æ–¥ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏.
  * –¢–µ–∫—É—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –ª—É—á—à–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è middleware.

---

```python
@database_sync_to_async
def get_user(user_id):
    try:
        return User.objects.get(id=user_id)
    except User.DoesNotExist:
        return None
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ—Å—Ç–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `id`. –ï—Å–ª–∏ –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`.
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** ORM Django —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –∞ WebSocket ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π. `database_sync_to_async` –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –Ω–µ ¬´–ø–æ–¥–≤–µ—à–∏–≤–∞–ª¬ª event loop.
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å ORM –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, Tortoise ORM).
  * –ù–æ —Ç–æ–≥–¥–∞ –ø—Ä–∏—à–ª–æ—Å—å –±—ã –º–µ–Ω—è—Ç—å –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `database_sync_to_async` ‚Äî —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.

---

```python
class JWTAuthMiddleware(BaseMiddleware):
    async def __call__(self, scope, receive, send):
        query_string = scope.get("query_string", b"").decode()
        query_params = parse_qs(query_string)
        token_list = query_params.get("token")
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

  * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∑–∞–ø—Ä–æ—Å–∞ (`?token=...`) –∏–∑ URL –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ WebSocket.
  * –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –µ—ë –≤ —Å–ª–æ–≤–∞—Ä—å (`query_params`).
  * –ë–µ—Ä—ë—Ç —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∫–ª—é—á–∞ `token`.
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** WebSocket –Ω–µ –∏–º–µ–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∫–∞–∫ HTTP), –ø–æ—ç—Ç–æ–º—É —Ç–æ–∫–µ–Ω –æ–±—ã—á–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `?token=...`.
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö (`Sec-WebSocket-Protocol`), –Ω–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ –∏ –Ω–µ –≤–µ–∑–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.
  * –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞ –≤ query string ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±.

---

```python
scope["user"] = AnonymousUser()
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞–≤–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ ¬´–≥–æ—Å—Ç—å¬ª (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω).
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –∏–ª–∏ –æ–Ω –±–∏—Ç—ã–π ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å—á–∏—Ç–∞—Ç—å—Å—è –∞–Ω–æ–Ω–∏–º–Ω—ã–º.
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É —Ä–æ–Ω—è—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (`DenyConnection`), –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç.
  * –ù–æ –∞–Ω–æ–Ω–∏–º–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤/—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–π). –ü–æ—ç—Ç–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç —Å `AnonymousUser` —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–µ–µ.

---

```python
access_token = AccessToken(token)
user_id = access_token["user_id"]
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

  * –ü–∞—Ä—Å–∏—Ç —Ç–æ–∫–µ–Ω –∫–∞–∫ JWT.
  * –î–æ—Å—Ç–∞—ë—Ç –∏–∑ –Ω–µ–≥–æ `user_id`.
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** SimpleJWT –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–ª–∞–¥—ë—Ç `user_id` –≤ payload —Ç–æ–∫–µ–Ω–∞.
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ —Ö—Ä–∞–Ω–∏—Ç—å email –∏–ª–∏ username –≤ —Ç–æ–∫–µ–Ω–µ.
  * –ù–æ `user_id` –ª—É—á—à–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –ë–î.

---

```python
user = await get_user(user_id)
if user:
    scope["user"] = user
else:
    raise DenyConnection("User not found")
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

  * –î–æ—Å—Ç–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –ø–æ `id`.
  * –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –∫–ª–∞–¥—ë—Ç –≤ `scope["user"]`.
  * –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ä–≤—ë—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Ç–æ–∫–µ–Ω –º–æ–≥ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω —Å—Ç–∞—Ä—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä–æ–≥–æ —É–∂–µ —É–¥–∞–ª–∏–ª–∏).
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ –æ—Å—Ç–∞–≤–∏—Ç—å `AnonymousUser`.
  * –ù–æ –ª—É—á—à–µ –æ–±–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–Ω—è–ª: ¬´–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å¬ª. –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ.

---

```python
except (TokenError, InvalidToken, KeyError):
    raise DenyConnection("Invalid or expired token")
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

  * –õ–æ–≤–∏—Ç –æ—à–∏–±–∫–∏ —Ç–æ–∫–µ–Ω–∞ (–±–∏—Ç—ã–π, –ø—Ä–æ—Ç—É—Ö—à–∏–π, –Ω–µ—Ç –ø–æ–ª—è `user_id`).
  * –†–∞–∑—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** –ù–µ–ª—å–∑—è –ø—É—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç —Å –∫—Ä–∏–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º.
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å `AnonymousUser`.
  * –ù–æ —Ä–µ–≤—å—é–≤–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–º–µ—Ç–∏–ª: **–ª—É—á—à–µ –¥–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É –∑–Ω–∞—Ç—å, —á—Ç–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞**, —á–µ–º –ø—Ä–∏—Ç–≤–æ—Ä—è—Ç—å—Å—è, —á—Ç–æ ¬´–≤—Å—ë –æ–∫¬ª.

---

## üîπ `consumers.py`

```python
user = self.scope.get('user', AnonymousUser())
if not user or not user.is_authenticated:
    await self.send(text_data=json.dumps({'error': 'Authentication required'}))
    await self.close()
    return
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

  * –ë–µ—Ä—ë—Ç `user`, –ø–æ–ª–æ–∂–µ–Ω–Ω—ã–π –≤ `scope` middleware.
  * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.
  * –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´Authentication required¬ª –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
* **–ü–æ—á–µ–º—É —Ç–∞–∫:** –î–∞–∂–µ –µ—Å–ª–∏ middleware –ø—É—Å—Ç–∏–ª ¬´–∞–Ω–æ–Ω–∏–º–∞¬ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–∫–µ–Ω –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω), consumer –æ–±—è–∑–∞–Ω –ø–µ—Ä–µ—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å—Å—è.
* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ–æ–±—â–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å ‚Äî –Ω–æ —Ç–æ–≥–¥–∞ —á–∞—Ç –ø—É—Å—Ç–∏–ª –±—ã –≤—Å–µ—Ö.
  * –ú–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ—Å—Ç–æ `await self.close()` –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –æ—à–∏–±–∫—É.

---

## üîπ `asgi.py`

```python
"websocket": AllowedHostsOriginValidator(
    AuthMiddlewareStack(
        JWTAuthMiddleware(
            URLRouter(websocket_urlpatterns))  
    )
),
```

* **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

  1. `AllowedHostsOriginValidator` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Å —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞.
  2. `AuthMiddlewareStack` ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è Django-–º–∏–¥–ª–≤–∞—Ä—å, –¥–æ–±–∞–≤–ª—è—é—â–∞—è `session` –∏ `cookies` –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ JWT –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).
  3. `JWTAuthMiddleware` ‚Äî —Ç–≤–æ—è –º–∏–¥–ª–≤–∞—Ä—å, –≤—ã—Ç–∞—Å–∫–∏–≤–∞—é—â–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ JWT.
  4. `URLRouter(websocket_urlpatterns)` ‚Äî —Ä–æ—É—Ç–∏–Ω–≥ WebSocket-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.

* **–ü–æ—á–µ–º—É —Ç–∞–∫:**

  * –≠—Ç–æ —Ü–µ–ø–æ—á–∫–∞ –º–∏–¥–ª–≤–∞—Ä–µ–π, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –∑–∞–¥–∞—á—É.
  * `JWTAuthMiddleware` –≤—Å—Ç–∞–≤–ª–µ–Ω –≤–Ω—É—Ç—Ä—å `AuthMiddlewareStack`, —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å/–¥–æ–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.

* **–ö–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ:**

  * –ú–æ–∂–Ω–æ –±—ã–ª–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `AuthMiddlewareStack` –∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `JWTAuthMiddleware`.
  * –ù–æ –ª—É—á—à–µ —Ç–∞–∫: —Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å session-based –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –∫–∞–Ω–∞–ª–æ–≤).

---

## üéØ –ò—Ç–æ–≥ ‚Äî –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ –Ω–∞–ø–∏—Å–∞–Ω–æ

* –ö–æ–¥ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:

  * `JWTAuthMiddleware` ‚Äî –¥–æ—Å—Ç–∞—ë—Ç user –∏–∑ JWT.
  * `Consumer` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ user —Ä–µ–∞–ª—å–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.
  * `asgi.py` ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å—ë –≤ –æ–¥–Ω—É —Ü–µ–ø–æ—á–∫—É.
* –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –≥–∏–±–∫–∏–π:

  * –º–æ–∂–Ω–æ –ø—É—Å–∫–∞—Ç—å –∞–Ω–æ–Ω–∏–º–æ–≤ –≤ –ø—É–±–ª–∏—á–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã,
  * –º–æ–∂–Ω–æ —Ç—Ä–µ–±–æ–≤–∞—Ç—å JWT –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö,
  * –º–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å cookie-based –ª–æ–≥–∏–Ω–æ–º.

üëâ –≠—Ç–æ –∏ –µ—Å—Ç—å ¬´–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, production-ready –≤–∞—Ä–∏–∞–Ω—Ç¬ª.

---

–•–æ—á–µ—à—å, —è –Ω–∞—Ä–∏—Å—É—é **—Å—Ö–µ–º—É-–ø–æ—Ç–æ–∫ (flow)**, –≥–¥–µ —à–∞–≥ –∑–∞ —à–∞–≥–æ–º –ø–æ–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ WebSocket-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –≤—Å–µ —ç—Ç–∏ —Å–ª–æ–∏?


